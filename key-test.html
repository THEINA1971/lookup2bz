<!doctype html>
<html lang="fr">
    <head>
        <meta charset="UTF-8" />
        <meta name="viewport" content="width=device-width, initial-scale=1.0" />
        <title>Admin Dashboard & Test Panel - FULLLOOKUP</title>
        <link
            href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.0.0/css/all.min.css"
            rel="stylesheet"
        />
        <style>
            :root {
                --bg-color: #0f0f13;
                --card-bg: #1a1a23;
                --text-color: #e0e0e0;
                --accent-color: #ef4444; /* Red for admin/danger */
                --primary-color: #3b82f6; /* Blue for info */
                --success-color: #10b981;
                --border-color: #333;
            }

            * {
                margin: 0;
                padding: 0;
                box-sizing: border-box;
                font-family:
                    "Segoe UI",
                    system-ui,
                    -apple-system,
                    sans-serif;
            }

            body {
                background-color: var(--bg-color);
                color: var(--text-color);
                min-height: 100vh;
                display: flex;
                flex-direction: column;
                align-items: center;
                padding: 2rem;
            }

            .container {
                width: 100%;
                max-width: 1200px;
                display: grid;
                grid-template-columns: 1fr;
                gap: 2rem;
            }

            @media (min-width: 992px) {
                .container {
                    grid-template-columns: 1fr 1fr;
                }
            }

            h1 {
                grid-column: 1 / -1;
                text-align: center;
                margin-bottom: 2rem;
                font-size: 2.5rem;
                background: linear-gradient(
                    45deg,
                    var(--accent-color),
                    #f87171
                );
                -webkit-background-clip: text;
                -webkit-text-fill-color: transparent;
                text-transform: uppercase;
                letter-spacing: 2px;
            }

            .card {
                background-color: var(--card-bg);
                border-radius: 16px;
                padding: 2rem;
                border: 1px solid var(--border-color);
                box-shadow: 0 4px 20px rgba(0, 0, 0, 0.3);
                transition:
                    transform 0.2s,
                    box-shadow 0.2s;
            }

            .card:hover {
                transform: translateY(-2px);
                box-shadow: 0 8px 30px rgba(0, 0, 0, 0.4);
                border-color: var(--border-color);
            }

            .card-header {
                display: flex;
                align-items: center;
                margin-bottom: 1.5rem;
                padding-bottom: 1rem;
                border-bottom: 1px solid var(--border-color);
            }

            .card-header i {
                font-size: 1.5rem;
                margin-right: 1rem;
            }

            .card-header h2 {
                font-size: 1.25rem;
                font-weight: 600;
            }

            /* Color themes for cards */
            .card.admin {
                border-top: 4px solid var(--accent-color);
            }
            .card.admin .card-header i {
                color: var(--accent-color);
            }

            .card.user {
                border-top: 4px solid var(--primary-color);
            }
            .card.user .card-header i {
                color: var(--primary-color);
            }

            .card.status {
                border-top: 4px solid var(--success-color);
            }
            .card.status .card-header i {
                color: var(--success-color);
            }

            .form-group {
                margin-bottom: 1.25rem;
            }

            label {
                display: block;
                margin-bottom: 0.5rem;
                font-size: 0.9rem;
                color: #aaa;
            }

            input,
            select {
                width: 100%;
                padding: 0.75rem 1rem;
                background-color: #0f0f13;
                border: 1px solid var(--border-color);
                border-radius: 8px;
                color: white;
                font-size: 1rem;
                transition: border-color 0.2s;
            }

            input:focus,
            select:focus {
                outline: none;
                border-color: var(--primary-color);
            }

            .checkbox-group {
                display: flex;
                align-items: center;
                gap: 0.5rem;
            }

            .checkbox-group input {
                width: auto;
            }

            .btn {
                width: 100%;
                padding: 0.85rem;
                border: none;
                border-radius: 8px;
                font-weight: 600;
                cursor: pointer;
                transition: filter 0.2s;
                text-transform: uppercase;
                letter-spacing: 1px;
                display: flex;
                justify-content: center;
                align-items: center;
                gap: 0.5rem;
            }

            .btn-admin {
                background: linear-gradient(
                    135deg,
                    var(--accent-color),
                    #b91c1c
                );
                color: white;
            }

            .btn-user {
                background: linear-gradient(
                    135deg,
                    var(--primary-color),
                    #1d4ed8
                );
                color: white;
            }

            .btn-check {
                background-color: #374151;
                color: white;
            }

            .btn:hover {
                filter: brightness(1.1);
            }

            .btn:disabled {
                opacity: 0.6;
                cursor: not-allowed;
                filter: none;
            }

            .result-box {
                margin-top: 1rem;
                padding: 1rem;
                background-color: rgba(0, 0, 0, 0.3);
                border-radius: 8px;
                font-family: monospace;
                font-size: 0.9rem;
                white-space: pre-wrap;
                display: none; /* Hidden by default */
                border-left: 3px solid transparent;
            }

            .result-box.success {
                border-color: var(--success-color);
                color: #a7f3d0;
            }
            .result-box.error {
                border-color: var(--accent-color);
                color: #fecaca;
            }

            .key-display {
                background: rgba(239, 68, 68, 0.1);
                border: 1px solid var(--accent-color);
                border-radius: 8px;
                padding: 1.5rem;
                text-align: center;
                margin-top: 1rem;
                animation: fadeIn 0.5s;
            }

            .key-code {
                font-size: 1.5rem;
                font-weight: bold;
                color: var(--accent-color);
                margin: 0.5rem 0;
                font-family: monospace;
                cursor: pointer;
            }

            .key-code:hover {
                text-decoration: underline;
            }

            @keyframes fadeIn {
                from {
                    opacity: 0;
                    transform: translateY(10px);
                }
                to {
                    opacity: 1;
                    transform: translateY(0);
                }
            }

            .token-status {
                font-size: 0.8rem;
                padding: 0.2rem 0.5rem;
                border-radius: 4px;
                margin-left: auto;
            }

            .token-valid {
                background-color: rgba(16, 185, 129, 0.2);
                color: var(--success-color);
            }
            .token-invalid {
                background-color: rgba(239, 68, 68, 0.2);
                color: var(--accent-color);
            }

            .hidden {
                display: none;
            }
        </style>
    </head>
    <body>
        <h1><i class="fas fa-shield-alt"></i> Dashboard Admin & Test</h1>

        <div class="container">
            <!-- ADMIN SECTION -->
            <div class="card admin">
                <div class="card-header">
                    <i class="fas fa-user-shield"></i>
                    <h2>Connexion Admin</h2>
                    <span id="adminStatus" class="token-status token-invalid"
                        >Non connecté</span
                    >
                </div>

                <div id="adminLoginForm">
                    <div class="form-group">
                        <label>Email Admin</label>
                        <input
                            type="email"
                            id="adminEmail"
                            value="admin@fullookup.com"
                            placeholder="admin@fullookup.com"
                        />
                    </div>
                    <div class="form-group">
                        <label>Mot de passe</label>
                        <input
                            type="password"
                            id="adminPassword"
                            value="Admin123!"
                            placeholder="Admin123!"
                        />
                    </div>
                    <button onclick="loginAdmin()" class="btn btn-admin">
                        <i class="fas fa-sign-in-alt"></i> Se connecter
                    </button>
                </div>

                <div id="adminActions" class="hidden">
                    <div
                        class="form-group"
                        style="
                            margin-top: 1rem;
                            padding-top: 1rem;
                            border-top: 1px solid #333;
                        "
                    >
                        <label>Token Admin (Auto)</label>
                        <input
                            type="text"
                            id="adminToken"
                            readonly
                            style="opacity: 0.5; font-size: 0.8rem"
                        />
                    </div>
                    <button onclick="logoutAdmin()" class="btn btn-check">
                        <i class="fas fa-sign-out-alt"></i> Déconnexion
                    </button>
                </div>

                <div id="adminResult" class="result-box"></div>
            </div>

            <!-- GENERATE KEY SECTION -->
            <div class="card admin">
                <div class="card-header">
                    <i class="fas fa-key"></i>
                    <h2>Générer une Clé</h2>
                </div>

                <div class="form-group">
                    <label>Nom de la clé (Optionnel)</label>
                    <input
                        type="text"
                        id="keyName"
                        placeholder="Ex: Clé client VIP"
                    />
                </div>

                <div class="form-group">
                    <label>Durée de validité</label>
                    <select id="keyDuration">
                        <option value="1h">1 Heure</option>
                        <option value="1d">1 Jour</option>
                        <option value="1w">1 Semaine</option>
                        <option value="1m" selected>1 Mois</option>
                        <option value="6m">6 Mois</option>
                        <option value="1y">1 An</option>
                        <option value="lifetime">À vie</option>
                    </select>
                </div>

                <div class="form-group checkbox-group">
                    <input type="checkbox" id="isAdminKey" />
                    <label
                        for="isAdminKey"
                        style="margin-bottom: 0; color: #fff"
                        >Clé Admin (Réutilisable)</label
                    >
                </div>

                <button
                    onclick="generateKey()"
                    class="btn btn-admin"
                    id="btnGenKey"
                    disabled
                >
                    <i class="fas fa-plus-circle"></i> Générer la clé
                </button>

                <div id="generateResult" class="result-box"></div>
            </div>

            <!-- USER REGISTRATION SECTION -->
            <div class="card user">
                <div class="card-header">
                    <i class="fas fa-user-plus"></i>
                    <h2>Inscription Utilisateur</h2>
                </div>

                <p style="margin-bottom: 1rem; font-size: 0.9rem; color: #888">
                    Utilisez la clé générée pour créer un compte.
                </p>

                <div class="form-group">
                    <label>Clé d'inscription</label>
                    <input
                        type="text"
                        id="registerKey"
                        placeholder="XXXX-XXXX-XXXX"
                    />
                </div>

                <div class="form-group">
                    <label>Email</label>
                    <input
                        type="email"
                        id="registerEmail"
                        placeholder="user@example.com"
                    />
                </div>

                <div class="form-group">
                    <label>Mot de passe</label>
                    <input
                        type="password"
                        id="registerPassword"
                        placeholder="Minimum 8 caractères"
                    />
                </div>

                <button onclick="registerUser()" class="btn btn-user">
                    <i class="fas fa-user-check"></i> S'inscrire
                </button>

                <div id="registerResult" class="result-box"></div>
            </div>

            <!-- USER LOGIN SECTION -->
            <div class="card user">
                <div class="card-header">
                    <i class="fas fa-sign-in-alt"></i>
                    <h2>Connexion Utilisateur</h2>
                </div>

                <p style="margin-bottom: 1rem; font-size: 0.9rem; color: #888">
                    Connexion classique après inscription.
                </p>

                <div class="form-group">
                    <label>Email</label>
                    <input
                        type="email"
                        id="loginEmail"
                        placeholder="user@example.com"
                    />
                </div>

                <div class="form-group">
                    <label>Mot de passe</label>
                    <input
                        type="password"
                        id="loginPassword"
                        placeholder="********"
                    />
                </div>

                <button onclick="loginUser()" class="btn btn-user">
                    <i class="fas fa-arrow-right"></i> Se connecter
                </button>

                <div id="loginResult" class="result-box"></div>
            </div>
        </div>

        <script>
            const API_BASE = window.location.origin + "/api";

            // --- UTILS ---
            function showResult(elementId, data, isError = false) {
                const el = document.getElementById(elementId);
                el.style.display = "block";
                el.className = `result-box ${isError ? "error" : "success"}`;

                if (typeof data === "object") {
                    el.textContent = JSON.stringify(data, null, 2);
                } else {
                    el.textContent = data;
                }
            }

            function copyToClipboard(text) {
                navigator.clipboard.writeText(text).then(() => {
                    alert("Copié : " + text);
                });
            }

            // --- AUTH ADMIN ---
            function updateAdminUI(token) {
                const statusEl = document.getElementById("adminStatus");
                const loginForm = document.getElementById("adminLoginForm");
                const actions = document.getElementById("adminActions");
                const tokenInput = document.getElementById("adminToken");
                const btnGen = document.getElementById("btnGenKey");

                if (token) {
                    statusEl.textContent = "Connecté";
                    statusEl.className = "token-status token-valid";
                    loginForm.classList.add("hidden");
                    actions.classList.remove("hidden");
                    tokenInput.value = token;
                    btnGen.disabled = false;
                } else {
                    statusEl.textContent = "Non connecté";
                    statusEl.className = "token-status token-invalid";
                    loginForm.classList.remove("hidden");
                    actions.classList.add("hidden");
                    tokenInput.value = "";
                    btnGen.disabled = true;
                }
            }

            async function loginAdmin() {
                const email = document.getElementById("adminEmail").value;
                const password = document.getElementById("adminPassword").value;

                try {
                    const res = await fetch(`${API_BASE}/auth/admin-login`, {
                        method: "POST",
                        headers: { "Content-Type": "application/json" },
                        body: JSON.stringify({ email, password }),
                    });
                    const data = await res.json();

                    if (res.ok) {
                        localStorage.setItem("adminToken", data.token);
                        updateAdminUI(data.token);
                        showResult(
                            "adminResult",
                            "Connexion réussie ! Vous pouvez maintenant générer des clés.",
                        );
                    } else {
                        showResult(
                            "adminResult",
                            data.error || "Erreur de connexion",
                            true,
                        );
                    }
                } catch (e) {
                    showResult("adminResult", e.message, true);
                }
            }

            function logoutAdmin() {
                localStorage.removeItem("adminToken");
                updateAdminUI(null);
                document.getElementById("adminResult").style.display = "none";
            }

            // --- KEY GENERATION ---
            async function generateKey() {
                const token = localStorage.getItem("adminToken");
                if (!token) {
                    showResult(
                        "generateResult",
                        "Token invalide ou expiré. Veuillez vous reconnecter.",
                        true,
                    );
                    updateAdminUI(null); // Force logout visually
                    return;
                }

                const name = document.getElementById("keyName").value;
                const duration = document.getElementById("keyDuration").value;
                const isAdmin = document.getElementById("isAdminKey").checked;

                // Generate random code client-side or let backend handle it.
                // The backend endpoint `/api/keys` expects a code, or generates one if we use the logic I saw previously?
                // Actually, in the backend code I removed `/api/keys/generate` and updated `/api/keys` POST.
                // But wait, the previous `create_key` function (POST /api/keys) requires a `code` or it fails with 400.
                // Let's generate a random code here to be safe.
                const randomCode =
                    "KEY-" +
                    Math.random().toString(36).substr(2, 9).toUpperCase();

                try {
                    const res = await fetch(`${API_BASE}/keys`, {
                        method: "POST",
                        headers: {
                            "Content-Type": "application/json",
                            Authorization: `Bearer ${token}`,
                        },
                        body: JSON.stringify({
                            code: randomCode,
                            name: name,
                            duration: duration,
                            is_admin: isAdmin,
                        }),
                    });
                    const data = await res.json();

                    if (res.ok) {
                        const resultHtml =
                            document.getElementById("generateResult");
                        resultHtml.style.display = "block";
                        resultHtml.className = "result-box success";
                        resultHtml.innerHTML = `
                        <div style="text-align: center;">
                            <div>✅ Clé générée avec succès !</div>
                            <div class="key-display">
                                <div style="font-size: 0.8rem; color: #aaa;">CLIQUEZ POUR COPIER</div>
                                <div class="key-code" onclick="copyToClipboard('${data.key.code}')">${data.key.code}</div>
                                <div style="margin-top: 0.5rem; font-size: 0.9rem;">
                                    Type: <strong>${data.key.is_admin ? "Admin" : "Utilisateur"}</strong> |
                                    Expire: <strong>${data.key.duration}</strong>
                                </div>
                            </div>
                        </div>
                    `;

                        // Auto-fill register form
                        document.getElementById("registerKey").value =
                            data.key.code;
                    } else {
                        if (data.error && data.error.includes("Token")) {
                            // Token issue
                            showResult(
                                "generateResult",
                                "Session expirée. Reconnectez-vous.",
                                true,
                            );
                            logoutAdmin();
                        } else {
                            showResult(
                                "generateResult",
                                data.error || "Erreur inconnue",
                                true,
                            );
                        }
                    }
                } catch (e) {
                    showResult("generateResult", e.message, true);
                }
            }

            // --- USER REGISTER ---
            async function registerUser() {
                const key = document.getElementById("registerKey").value;
                const email = document.getElementById("registerEmail").value;
                const password =
                    document.getElementById("registerPassword").value;

                if (!key || !email || !password) {
                    showResult(
                        "registerResult",
                        "Tous les champs sont requis.",
                        true,
                    );
                    return;
                }

                try {
                    const res = await fetch(
                        `${API_BASE}/auth/register-with-key`,
                        {
                            method: "POST",
                            headers: { "Content-Type": "application/json" },
                            body: JSON.stringify({ key, email, password }),
                        },
                    );
                    const data = await res.json();

                    if (res.ok) {
                        showResult(
                            "registerResult",
                            `Compte créé avec succès !\nUtilisateur : ${data.user.username}\nID : ${data.user.id}`,
                        );
                        // Auto fill login
                        document.getElementById("loginEmail").value = email;
                        document.getElementById("loginPassword").value =
                            password;
                    } else {
                        showResult(
                            "registerResult",
                            data.error || "Erreur",
                            true,
                        );
                    }
                } catch (e) {
                    showResult("registerResult", e.message, true);
                }
            }

            // --- USER LOGIN ---
            async function loginUser() {
                const email = document.getElementById("loginEmail").value;
                const password = document.getElementById("loginPassword").value;

                try {
                    const res = await fetch(`${API_BASE}/auth/login`, {
                        method: "POST",
                        headers: { "Content-Type": "application/json" },
                        body: JSON.stringify({ email, password }),
                    });
                    const data = await res.json();

                    if (res.ok) {
                        showResult(
                            "loginResult",
                            `✅ Connexion réussie !\nToken : ${data.token.substring(0, 20)}...\nRole : ${data.user.role}`,
                        );
                    } else {
                        showResult("loginResult", data.error || "Erreur", true);
                    }
                } catch (e) {
                    showResult("loginResult", e.message, true);
                }
            }

            // --- INIT ---
            window.onload = function () {
                const storedAdminToken = localStorage.getItem("adminToken");
                if (storedAdminToken) {
                    updateAdminUI(storedAdminToken);
                }
            };
        </script>
    </body>
</html>
